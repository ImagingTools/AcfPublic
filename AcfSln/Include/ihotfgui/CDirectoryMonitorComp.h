/********************************************************************************
**
**	Copyright (C) 2007-2017 Witold Gantzke & Kirill Lepskiy
**
**	This file is part of the ACF-Solutions Toolkit.
**
**	This file may be used under the terms of the GNU Lesser
**	General Public License version 2.1 as published by the Free Software
**	Foundation and appearing in the file LicenseLGPL.txt included in the
**	packaging of this file.  Please review the following information to
**	ensure the GNU Lesser General Public License version 2.1 requirements
**	will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
**
**	If you are unsure which license is appropriate for your use, please
**	contact us at info@imagingtools.de.
**
** 	See http://www.ilena.org or write info@imagingtools.de for further
** 	information about the ACF.
**
********************************************************************************/


#ifndef ihotfgui_CDirectoryMonitorComp_included
#define ihotfgui_CDirectoryMonitorComp_included


// Qt includes
#include <QtCore/QFileSystemWatcher>
#include <QtCore/QThread>
#include <QtCore/QDir>
#include <QtCore/QSet>
#include <QtCore/QTextStream>
#include <QtCore/QMutex>

// ACF includes
#include <imod/TSingleModelObserverBase.h>
#include <icomp/CComponentBase.h>
#include <ilog/TLoggerCompWrap.h>
#include <iprm/IParamsSet.h>
#include <ifile/IFileNameParam.h>

// AcfSln includes
#include <ihotf/IFileSystemChangeStorage.h>
#include <ihotf/IDirectoryMonitor.h>
#include <ihotf/IDirectoryMonitorParams.h>
#include <ihotf/IMonitoringSessionManager.h>


namespace ihotfgui
{


/**
	Component for monitoring of the file folder.
*/
class CDirectoryMonitorComp:
			public QThread,
			public ilog::CLoggerComponentBase,
			virtual public ihotf::IDirectoryMonitor
{
	Q_OBJECT

public:
	typedef ilog::CLoggerComponentBase BaseClass;
	typedef QThread BaseClass2;

	I_BEGIN_COMPONENT(CDirectoryMonitorComp);
		I_REGISTER_INTERFACE(ihotf::IDirectoryMonitor);
		I_ASSIGN(m_paramsSetCompPtr, "ParamsSet", "Default parameter set for the directory monitoring", false, "ParamsSet");
		I_ASSIGN_TO(m_paramsSetModelCompPtr, m_paramsSetCompPtr, false);
		I_ASSIGN(m_monitoringSessionManagerCompPtr, "SessionManager", "Provider of previous monitoring sessions", false, "SessionManager");
		I_ASSIGN(m_fileSystemChangeStorageCompPtr, "FileSystemChangeStorage", "File storage", true, "FileSystemChangeStorage");
		I_ASSIGN(m_traceFileFolderCompPtr, "TraceFileFolder", "Location for the trace file", false, "TraceFileFolder");
		I_ASSIGN(m_directoryPathIdAttrPtr, "DirParamId", "Parameter ID of the path to be observed in the parameter set", true, "DirParamId");
		I_ASSIGN(m_directoryMonitorParamsIdAttrPtr, "DirectoryMonitorParamsId", "ID of the directory observing parameters in the parameter set", true, "DirectoryMonitorParamsId");
		I_ASSIGN(m_enableTraceParamIdAttrPtr, "EnableTraceParamId", "ID of the trace enable parameter in the parameter set", true, "EnableTrace");
		I_ASSIGN(m_autoStartAttrPtr, "AutoStart", "If enabled, start the directory monitoring after initialization", false, false);
	I_END_COMPONENT;

	CDirectoryMonitorComp();

	// reimplemented (ihotf::IDirectoryMonitor)
	virtual bool IsRunning() const override;
	virtual bool StartObserving(const iprm::IParamsSet* paramsSetPtr = NULL) override;
	virtual void StopObserving() override;

protected:
	// reimplemented (icomp::CComponentBase)
	virtual void OnComponentCreated() override;
	virtual void OnComponentDestroyed() override;

	// reimplemented (QThread)
	virtual void run() override;

private Q_SLOTS:
	/**
		Delegate folder change event via istd::CChangeNotifier from main thread.
	*/
	void OnFolderChanged(const istd::IChangeable::ChangeSet& changeSet);

	/**
		Notification about changes in a given directory.
	*/
	void OnDirectoryChangeNotification(const QString& directory);

Q_SIGNALS:
	/**
		Signal is emitted from observing thread to notifiy the main thread about changes in a directory.
	*/
	void FolderChanged(const istd::IChangeable::ChangeSet& changeSet);

private:
	struct FileAccessInfo
	{
		FileAccessInfo()
			:fileSize(0)
		{
		}

		QDateTime checkTimeStamp;
		QDateTime lastAccessTimeStamp;
		qint64 fileSize;
	};

	typedef QMap<QString, FileAccessInfo> FileAccessMap;


	void SetFolderPath(const QString& folderPath);
	void StartObserverThread();
	void StopObserverThread();
	void ResetFiles();
	bool ConnectToParameterModel(const iprm::IParamsSet& paramsSet);
	void DisconnectFromParameterModel();
	void UpdateMonitoringSession() const;
	bool HasFileAccess(const QString& filePath, FileAccessInfo& lastFileAccessInfo) const;
	bool CheckFileAccess(const QString& filePath) const;
	QDateTime GetLastAccessTime(const QFileInfo& fileInfo) const;
	void UpdateNonAccessedFiles(FileAccessMap& accessMap, QStringList& fileList);
	void EnableTracing(bool tracingEnabled);
	void WriteTraceMessage(const QString& traceMessage) const;

private:
	struct FileSystemChanges
	{
		QStringList addedFiles;
		QStringList removedFiles;
		QStringList modifiedFiles;
		QStringList attributeChangedFiles;
	};

	/**
		\internal
	*/
	class MonitoringParamsObserver: public imod::TSingleModelObserverBase<ihotf::IDirectoryMonitorParams>
	{
	public:
		typedef imod::TSingleModelObserverBase<ihotf::IDirectoryMonitorParams> BaseClass;

		MonitoringParamsObserver(CDirectoryMonitorComp& parent);

		// reimplemented (imod::IObserver)
		virtual void AfterUpdate(imod::IModel* modelPtr, const istd::IChangeable::ChangeSet& changeSet) override;

	private:
		CDirectoryMonitorComp& m_parent;
	};

	/**
		\internal
	*/
	class DirectoryParamsObserver: public imod::TSingleModelObserverBase<ifile::IFileNameParam>
	{
	public:
		typedef imod::TSingleModelObserverBase<ifile::IFileNameParam> BaseClass;

		DirectoryParamsObserver(CDirectoryMonitorComp& parent);

		// reimplemented (imod::IObserver)
		virtual void AfterUpdate(imod::IModel* modelPtr, const istd::IChangeable::ChangeSet& changeSet) override;

	private:
		CDirectoryMonitorComp& m_parent;
	};

	ihotf::IMonitoringSession::FileItems m_directoryFiles;
	FileAccessMap m_nonAccessedAddedFiles;
	FileAccessMap m_nonAccessedModifiedFiles;

	bool m_finishThread;

	FileSystemChanges m_folderChanges;

	QDir m_currentDirectory;

	int m_directoryPendingChangesCounter;

	QFileSystemWatcher m_directoryWatcher;

	// Model shadows:
	double m_pollingFrequency;
	QStringList m_fileFilterExpressions;
	int m_observingItemTypes;
	int m_observingChanges;
	int m_lastModificationMinDifference;
	int m_folderDepth;
	int m_timestampMode;

	MonitoringParamsObserver m_monitoringParamsObserver;
	DirectoryParamsObserver m_directoryParamsObserver;

	// Component attributes
	I_REF(iprm::IParamsSet, m_paramsSetCompPtr);
	I_REF(imod::IModel, m_paramsSetModelCompPtr);
	I_REF(ihotf::IMonitoringSessionManager, m_monitoringSessionManagerCompPtr);
	I_REF(ihotf::IFileSystemChangeStorage, m_fileSystemChangeStorageCompPtr);
	I_REF(ifile::IFileNameParam, m_traceFileFolderCompPtr);
	I_ATTR(QByteArray, m_directoryPathIdAttrPtr);
	I_ATTR(QByteArray, m_directoryMonitorParamsIdAttrPtr);
	I_ATTR(bool, m_autoStartAttrPtr);
	I_ATTR(QByteArray, m_enableTraceParamIdAttrPtr);

	bool m_lockChanges;

	ihotf::IDirectoryMonitorParams::WorkingMode m_workingMode;

	mutable QMutex m_mutex;

	bool m_isTraceEnabled;
	mutable QMutex m_traceFileMutex;
	istd::TDelPtr<QFile> m_traceFilePtr;
	mutable QTextStream m_traceStream;
};


} // namespace ihotfgui


#endif // !ihotfgui_CDirectoryMonitorComp_included


