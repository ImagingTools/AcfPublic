/********************************************************************************
**
**	Copyright (C) 2007-2017 Witold Gantzke & Kirill Lepskiy
**
**	This file is part of the ACF-Solutions Toolkit.
**
**	This file may be used under the terms of the GNU Lesser
**	General Public License version 2.1 as published by the Free Software
**	Foundation and appearing in the file LicenseLGPL.txt included in the
**	packaging of this file.  Please review the following information to
**	ensure the GNU Lesser General Public License version 2.1 requirements
**	will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
**
**	If you are unsure which license is appropriate for your use, please
**	contact us at info@imagingtools.de.
**
** 	See http://www.ilena.org or write info@imagingtools.de for further
** 	information about the ACF.
**
********************************************************************************/


#pragma once


// Qt includes
#include <QtCore/QMap>

// ACF includes
#include <istd/TDelPtr.h>
#include <istd/CGeneralTimeStamp.h>
#include <iser/IArchive.h>
#include <icomm/IRequestsManager.h>
#include <icomm/IRequest.h>


namespace icomm
{


/**
	Standard implementation of icomm::IRequestsManager interface.
 */
class CRequestsManagerBase: public IRequestsManager
{
public:
	/**
		Removes all container from this manager.
	*/
	void Reset();

	/**
		This mathod should be called from end implementation when new message is received.
	*/
	bool OnReceived(iser::IArchive& archive);

	// reimplemented (icomm::IRequestsManager)
	virtual QByteArray AddRequest(IRequest* requestPtr);
	virtual RequestState WaitRequestFinished(
				const QByteArray& requestId = QByteArray(),
				bool killOnTimeout = true,
				RequestInfo* requestInfoPtr = NULL) const;
	virtual void Flush();

protected:
	struct RequestData
	{
		RequestState state;
		QString errorMessage;
		double validityTime;
		istd::TDelPtr<IRequest> requestPtr;
	};

	typedef QMap<QByteArray, RequestData> RequestsMap;

	// abstract methods
	/**
		Get access to internal archive object.
		Every archive created with this method should be removed
		using RemoveSendArchive() method.
		\return		Pointer to created archive object, or NULL if error.
	*/
	virtual iser::IArchive* CreateSendArchive() = 0;

	/**
		Flush internal archive object.
		\param	archive		archive object created using CreateSendArchive() method.
		\param	wasError	signalize that an error occured during processing of this archive and it shouldn't be sent (only remove).
		\return				true, if no erorrs occured during sending.
	*/
	virtual bool RemoveSendArchive(iser::IArchive& archive, bool wasError = false) = 0;

private:
	mutable RequestsMap m_requestsMap;
	istd::CGeneralTimeStamp m_timer;
};


} // namespace icomm

