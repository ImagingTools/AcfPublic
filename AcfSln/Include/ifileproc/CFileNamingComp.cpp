/********************************************************************************
**
**	Copyright (C) 2007-2015 Witold Gantzke & Kirill Lepskiy
**
**	This file is part of the ACF-Solutions Toolkit.
**
**	This file may be used under the terms of the GNU Lesser
**	General Public License version 2.1 as published by the Free Software
**	Foundation and appearing in the file LicenseLGPL.txt included in the
**	packaging of this file.  Please review the following information to
**	ensure the GNU Lesser General Public License version 2.1 requirements
**	will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
**
**	If you are unsure which license is appropriate for your use, please
**	contact us at info@imagingtools.de.
**
** 	See http://www.ilena.org or write info@imagingtools.de for further
** 	information about the ACF.
**
********************************************************************************/


#include <ifileproc/CFileNamingComp.h>


// Qt includes
#include <QtCore/QFileInfo>
#include <QtCore/QDir>


namespace ifileproc
{


// public methods

// reimplemented (ifileproc::IFileNaming)

QString CFileNamingComp::CalculateFileName(
			const QString& inputFilePath,
			const QString& outputDirectoryPath,
			const ifileproc::IFileNamingParams* fileNamingParamsPtr) const
{
	QString targetDirectoryPath = outputDirectoryPath;

	if (targetDirectoryPath.isEmpty()){
		if (!m_directoryPathCompPtr.IsValid()){
			return QString();
		}

		targetDirectoryPath = m_directoryPathCompPtr->GetPath();
	}

	QFileInfo inputFileInfo(inputFilePath);
	QString baseFileName = inputFileInfo.completeBaseName();
	QString outputExtension = inputFileInfo.suffix();

	if (fileNamingParamsPtr == NULL){
		fileNamingParamsPtr = m_fileNamingParamsCompPtr.GetPtr();
	}

	// Remove patterns to be ingnored:

	// Calculate the base file name:
	if (fileNamingParamsPtr != NULL){
		baseFileName = fileNamingParamsPtr->GetPrefix() + baseFileName;
		baseFileName += fileNamingParamsPtr->GetSuffix();
	}

	// Calculate the new extension:
	if (m_fileTypeInfoCompPtr.IsValid()){
		QStringList supportedExtensions;
		m_fileTypeInfoCompPtr->GetFileExtensions(supportedExtensions, NULL, ifile::IFileTypeInfo::QF_SAVE);

		QStringList::const_iterator inputFoundIter = qFind(supportedExtensions.begin(), supportedExtensions.end(), outputExtension);
		if (inputFoundIter == supportedExtensions.end()){
			if (supportedExtensions.isEmpty()){
				outputExtension.clear();
			}
			else{
				outputExtension = supportedExtensions[0];
			}
		}
	}

	QString newFileName = baseFileName;
	
	if (!outputExtension.isEmpty()){
		newFileName += QString(".") + outputExtension;
	}

	if (!targetDirectoryPath.isEmpty()){
		QDir outputDirectory(targetDirectoryPath);

		QString outputFilePath = outputDirectory.absoluteFilePath(newFileName);

		if (fileNamingParamsPtr != NULL){
			if (fileNamingParamsPtr->GetOverwriteStrategy() == ifileproc::IFileNamingParams::RM_OVERWRITE){
				return outputFilePath;
			}
			else{
				int counter = 0;
				while (true){
					QFileInfo outputFileInfo(outputFilePath);
					if (outputFileInfo.exists()){
						newFileName = QString("%1_%2").arg(baseFileName).arg(++counter, 3, 10, QChar('0')) + "." + outputExtension;
						
						outputFilePath = outputDirectory.absoluteFilePath(newFileName);
					}
					else{
						break;
					}
				}
			}
		}

		return outputDirectory.absoluteFilePath(newFileName);
	}

	return QString();
}


} // namespace ifileproc


