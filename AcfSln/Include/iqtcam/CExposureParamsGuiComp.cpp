/********************************************************************************
**
**	Copyright (c) 2007-2011 Witold Gantzke & Kirill Lepskiy
**
**	This file is part of the ACF-Solutions Toolkit.
**
**	This file may be used under the terms of the GNU Lesser
**	General Public License version 2.1 as published by the Free Software
**	Foundation and appearing in the file LicenseLGPL.txt included in the
**	packaging of this file.  Please review the following information to
**	ensure the GNU Lesser General Public License version 2.1 requirements
**	will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
**
**	If you are unsure which license is appropriate for your use, please
**	contact us at info@imagingtools.de.
**
** 	See http://www.ilena.org, write info@imagingtools.de or contact
**	by Skype to ACF_infoline for further information about the ACF-Solutions.
**
********************************************************************************/


#include "iqtcam/CExposureParamsGuiComp.h"


#include "istd/TChangeNotifier.h"

#include "icam/IExposureConstraints.h"


namespace iqtcam
{


// reimplemented (iqtgui::TGuiObserverWrap)

void CExposureParamsGuiComp::OnGuiModelAttached()
{
	BaseClass::OnGuiModelAttached();

	QObject::connect(ShutterTimeSB, SIGNAL(valueChanged(double)), this, SLOT(OnParamsChanged(double)));
	QObject::connect(DelayTimeSB, SIGNAL(valueChanged(double)), this, SLOT(OnParamsChanged(double)));
	QObject::connect(EenDelayTimeSB, SIGNAL(valueChanged(double)), this, SLOT(OnParamsChanged(double)));

	bool isShutterTimeSupported = false;
	bool isDelayTimeSupported = false;
	bool isEenDelayTimeSupported = false;

	const icam::IExposureParams* objectPtr = GetObjectPtr();
	if (objectPtr != NULL){
		const icam::IExposureConstraints* constraintsPtr = objectPtr->GetExposureConstraints();
		if (constraintsPtr != NULL){
			isShutterTimeSupported = !constraintsPtr->GetShutterTimeRange().IsEmpty();
			isDelayTimeSupported = !constraintsPtr->GetDelayTimeRange().IsEmpty();
			isEenDelayTimeSupported = !constraintsPtr->GetEenDelayRange().IsEmpty();
		}
	}

	ShutterTimeLabel->setVisible(isShutterTimeSupported);
	ShutterTimeSB->setVisible(isShutterTimeSupported);
	ShutterTimeUnitLabel->setVisible(isShutterTimeSupported);

	DelayTimeLabel->setVisible(isDelayTimeSupported);
	DelayTimeSB->setVisible(isDelayTimeSupported);
	DelayTimeUnitLabel->setVisible(isDelayTimeSupported);

	EenDelayTimeLabel->setVisible(isEenDelayTimeSupported);
	EenDelayTimeSB->setVisible(isEenDelayTimeSupported);
	EenDelayTimeUnitLabel->setVisible(isEenDelayTimeSupported);
}


void CExposureParamsGuiComp::OnGuiModelDetached()
{
	QObject::disconnect(ShutterTimeSB, SIGNAL(valueChanged(double)), this, SLOT(OnParamsChanged(double)));
	QObject::disconnect(DelayTimeSB, SIGNAL(valueChanged(double)), this, SLOT(OnParamsChanged(double)));
	QObject::disconnect(EenDelayTimeSB, SIGNAL(valueChanged(double)), this, SLOT(OnParamsChanged(double)));

	ShutterTimeLabel->setVisible(false);
	ShutterTimeSB->setVisible(false);
	ShutterTimeUnitLabel->setVisible(false);

	DelayTimeLabel->setVisible(false);
	DelayTimeSB->setVisible(false);
	DelayTimeUnitLabel->setVisible(false);

	EenDelayTimeLabel->setVisible(false);
	EenDelayTimeSB->setVisible(false);
	EenDelayTimeUnitLabel->setVisible(false);

	BaseClass::OnGuiModelDetached();
}


void CExposureParamsGuiComp::UpdateGui(int /*updateFlags*/)
{
	Q_ASSERT(IsGuiCreated());

	icam::IExposureParams* objectPtr = GetObjectPtr();
	if (objectPtr != NULL){
		ShutterTimeSB->setValue(objectPtr->GetShutterTime() * 1000.0);
		DelayTimeSB->setValue(objectPtr->GetDelayTime() * 1000.0);
		EenDelayTimeSB->setValue(objectPtr->GetEenDelay() * 1000.0);

		const icam::IExposureConstraints* constrainsPtr = objectPtr->GetExposureConstraints();
		if (constrainsPtr != NULL){
			ShutterTimeSB->setMinimum(constrainsPtr->GetShutterTimeRange().GetMinValue() * 1000.0);
			ShutterTimeSB->setMaximum(constrainsPtr->GetShutterTimeRange().GetMaxValue() * 1000.0);
			ShutterTimeSB->setSingleStep(0.01);

			DelayTimeSB->setMinimum(constrainsPtr->GetDelayTimeRange().GetMinValue() * 1000.0);
			DelayTimeSB->setMaximum(constrainsPtr->GetDelayTimeRange().GetMaxValue() * 1000.0);
			DelayTimeSB->setSingleStep(0.01);

			EenDelayTimeSB->setMinimum(constrainsPtr->GetEenDelayRange().GetMinValue() * 1000.0);
			EenDelayTimeSB->setMaximum(constrainsPtr->GetEenDelayRange().GetMaxValue() * 1000.0);
			EenDelayTimeSB->setSingleStep(0.01);
		}
	}
}


// reimplemented (imod::IModelEditor)

void CExposureParamsGuiComp::UpdateModel() const
{
	Q_ASSERT(IsGuiCreated());

	icam::IExposureParams* objectPtr = GetObjectPtr();
	Q_ASSERT(objectPtr != NULL);

	double tolerance = 0.9e-6;

	istd::CChangeNotifier notifier(NULL);

	double shutterTime = ShutterTimeSB->value() * 0.001;
	if (ShutterTimeSB->isVisible() && (qAbs(objectPtr->GetShutterTime() - shutterTime) > tolerance)){
		notifier.SetPtr(objectPtr);
		objectPtr->SetShutterTime(shutterTime);
	}

	double delayTime = DelayTimeSB->value() * 0.001;
	if (DelayTimeSB->isVisible() && (qAbs(objectPtr->GetDelayTime() - delayTime) > tolerance)){
		notifier.SetPtr(objectPtr);
		objectPtr->SetDelayTime(delayTime);
	}

	double eenDelayTime = EenDelayTimeSB->value() * 0.001;
	if (EenDelayTimeSB->isVisible() && (qAbs(objectPtr->GetEenDelay() - eenDelayTime) > tolerance)){
		notifier.SetPtr(objectPtr);
		objectPtr->SetEenDelay(eenDelayTime);
	}
}


// protected slots

void CExposureParamsGuiComp::OnParamsChanged(double /*value*/)
{
	DoUpdateModel();
}


} // namespace iqtcam


